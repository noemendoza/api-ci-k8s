# Test CircleCI/ARGOCD/Harbor/HELM/K8S
# Noe
# Test porpuses


version: 2.1
workflows:
  version: 2.1
  Test-Build-Publish:
    jobs:
      - Test
      #- build
      #- build_docker_publish:
      #    requires:
      #      - Test
      - sync_repo_helm:
          requires:
            - Test
      #- deploy_testing:
      #    type: 
      #      - approval
      #    requires:
      #      - build
      #      - make_build_docker
      #- deploy-production:
      #    requires:
      #     - deploy_testing
orbs:
  docker: circleci/docker@2.0.2

jobs:
  Test:
    docker:
      - image: circleci/node:10.24.1
    working_directory: ~/repo

    steps:
      - checkout
    # Download and cache dependencies
      - restore_cache:
          keys:
            - dependencies-{{ checksum "yarn.lock" }}
            - dependencies-
      - run: yarn install
      - save_cache:
          paths:
            - node_modules
            - /root/.cache/Cypress
          key: dependencies-{{ checksum "yarn.lock" }}
      - run: yarn test
 
  build_docker_publish:
    working_directory: ~/repo
    executor:
      name: docker/docker
      tag: '3.6'
    steps:

      - checkout
      - docker/install-docker-compose

      - setup_remote_docker:
          docker_layer_caching: true
      # - run:
      #     name: Build using `docker-compose`
      #     command: |
      #       docker-compose build
      # - run:
      #     name: Creating Network
      #     command: |
      #       docker network create proxy
      # - run:
      #     name: Up docker compose
      #     command: |
      #       docker-compose up -d
      # - run:
      #     name: Get docker name
      #     command: |
      #       docker-compose ps

      # - run:
      #     name: Start container and verify it's working
      #     command: |
      #       set -x

            
      #       docker container run --network container:repo_api_1 \
      #         docker.io/jwilder/dockerize \
      #         -wait http://localhost:3001/api/version  \
      #         -wait-retry-interval 2s \
      #         -timeout 20s  

      # - run:

      #     name: docker-compose down
      #     command: docker-compose down
      - run:
          name: Docker Login
          command: |
            echo "${PASS_PRIVATE_REGISTRY}" | docker login ${URL_PRIVATE_REGISTRY}  --username ${USER_PRIVATE_REGISTRY} --password-stdin 

      - run:
          name: Build Docker image TAG
          command: |
            TAG="0.1.${CIRCLE_BUILD_NUM}"
            docker build -t $VAR_PRIVATE_REGISTRY/circleci-demo:$TAG .

      - run:
          name: Push Docker image
          command: |
            TAG="0.1.${CIRCLE_BUILD_NUM}"
            docker push $VAR_PRIVATE_REGISTRY/circleci-demo:$TAG
      # run tests!
      #- run: yarn test
 

  sync_repo_helm:
    docker:
      - image: circleci/node:10.24.1
    working_directory: ~/repo

    steps:
      - checkout
      - run:
          name: Install YQ
          command: |
            sudo wget https://github.com/mikefarah/yq/releases/download/v4.20.1/yq_linux_amd64 -O /usr/bin/yq
            sudo chmod +x /usr/bin/yq
             yq --version

      - run:
          name: Update YML Chart.yml Dev
          command: |
            ls
            TAG="0.1.${CIRCLE_BUILD_NUM}"
            yq -i '.version = strenv(TAG)' charts/api-ci-dev/Chart.yaml          
            yq -i '.description = circleci-demo-strenv(TAG)' charts/api-ci-dev/Chart.yaml
            yq -i '.appVersion = strenv(TAG)' charts/api-ci-dev/Chart.yaml
            yq -i '.name = "circleci-demo"' charts/api-ci-dev/Chart.yaml

      - run:
          name: Update YML values.yml Dev
          command: |
            TAG="0.1.${CIRCLE_BUILD_NUM}"
            yq -i '.image.tag = strenv(TAG)' charts/api-ci-dev/values.yaml
            yq -i '.nameOverride = "circleci-demo"' charts/api-ci-dev/values.yaml
            yq -i '.fullnameOverride = "circleci-demo"' charts/api-ci-dev/values.yaml
            yq -i '.ingress.hosts[0].paths[0].path =  /strenv(TAG)' charts/api-ci-dev/values.yaml
            yq -i '.ingress.hosts[0].paths[0].backend.serviceName =  circleci-demo-ingress-strenv(TAG)' charts/api-ci-dev/values.yaml

      - run:
          name: Install Helm
          command: |
            curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
            chmod 700 get_helm.sh
            ./get_helm.sh
            helm version


      - run:
          name: Test Chart lint
          command: |
             cat charts/api-ci-dev/Chart.yaml
             helm lint charts/api-ci-dev/

      - run:
          name: Helm add remote repo and publish
          command: |
              
              helm repo add dircleci-demo --username ${USER_PRIVATE_REGISTRY} --password ${PASS_PRIVATE_REGISTRY} ${URL_PRIVATE_HELM}

              helm plugin install https://github.com/chartmuseum/helm-push
              helm cm-push charts/api-ci-dev/ dircleci-demo

  # deploy_to_server:
  #   machine:
  #     image: ubuntu-2004:202010-01
  #   steps:
  #     - run:
  #         name: Install OpenFortiVPN
  #         command: |
  #           sudo apt-get update
  #           sudo apt install openfortivpn -y
  #     - checkout
  #     - run:
  #         name: "Setting environment vars for test env"
  #         command: |
  #                   echo "export VPN_IP=${VAR_PRIVATE_VPN_IP}" >> ${BASH_ENV}
  #                   echo "export VPN_USER=${VAR_PRIVATE_VPN_USER}" >> ${BASH_ENV}
  #                   echo "export VPN_PORT=${VAR_PRIVATE_VPN_PORT}" >> ${BASH_ENV}
  #                   echo "export VPN_PASS=${VAR_PRIVATE_VPN_PASSWORD}" >> ${BASH_ENV}
  #     - run:
  #         name: Check IP before VPN connection
  #         command: |
  #           chmod +x .circleci/script.sh
  #           ./.circleci/script.sh
  #           ping -c 9 $SSH_HOSTNAME

  #     - run:
  #         name: Test ping for remote server
  #         command: |
  #           ping -c 4 $SSH_HOSTNAME
  #     - run: 
  #         name: Sync SSH keys
  #         command: |
  #           ssh-keyscan -H 10.0.13.10 >> ~/.ssh/known_hosts
  #     - run:
  #         name: RsyncProject test
  #         command: |
  #          rsync -avce ssh $SSH_USERNAME@$SSH_HOSTNAME:/home/$FIOLDER/apps/test


 
